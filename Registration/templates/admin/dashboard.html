{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Admin Dashboard</h2>
    <div class="text-muted">Welcome, <strong>{{ request.user.username }}</strong></div>
  </div>

  <!-- KPI Cards Section -->
  <div class="row g-3 mb-4">
    <!-- Total Users -->
    {% comment %} <div class="col-md-4 col-lg-2">
      <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="kpi-label">Total Users</div>
        <div class="kpi-value">{{ total_users }}</div>
      </div>
    </div> {% endcomment %}

    <!-- Total Students -->
    <div class="col-md-4 col-lg-2">
      <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="kpi-label">Total Students</div>
        <div class="kpi-value">{{ total_students }}</div>
      </div>
    </div>

    <!-- Year Registrations -->
    <div class="col-md-4 col-lg-2">
      <div class="kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <div class="kpi-label">This Year</div>
        <div class="kpi-value">{{ total_registered }}</div>
      </div>
    </div>

    <!-- Schools Participated -->
    <div class="col-md-4 col-lg-2">
      <div class="kpi-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <div class="kpi-label">Schools</div>
        <div class="kpi-value">{{ total_schools }}</div>
      </div>
    </div>

    <!-- Gender Count -->
    {% comment %} <div class="col-md-4 col-lg-2">
      <div class="kpi-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
        <div class="kpi-label">Genders</div>
        <div class="kpi-value">{{ gender_count }}</div>
      </div>
    </div> {% endcomment %}

    <!-- Category Count -->
    <div class="col-md-4 col-lg-2">
      <div class="kpi-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
        <div class="kpi-label">Categories</div>
        <div class="kpi-value">{{ category_count }}</div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row g-3">
    <!-- Gender Distribution -->




    <div class="col-md-6 col-xl-3">
      <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="chart-title mb-0">Gender Distribution</h6>
          <span class="badge bg-primary" id="genderTotal">0</span>
        </div>
        <canvas id="genderChart"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('genderChart', 'gender', 'png')">PNG</button>
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('genderChart', 'gender', 'jpg')">JPG</button>
        </div>
      </div>
    </div>

    <!-- Category Distribution -->
    <div class="col-md-6 col-xl-3">
      <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="chart-title mb-0">Category Distribution</h6>
          <span class="badge bg-primary" id="categoryTotal">0</span>
        </div>
        <canvas id="categoryChart"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('categoryChart', 'category', 'png')">PNG</button>
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('categoryChart', 'category', 'jpg')">JPG</button>
        </div>
      </div>
    </div>

    <!-- Division Distribution -->
    <div class="col-md-6 col-xl-3">
      <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="chart-title mb-0">Division Distribution</h6>
          <span class="badge bg-primary" id="divisionTotal">0</span>
        </div>
        <canvas id="divisionChart"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('divisionChart', 'division', 'png')">PNG</button>
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('divisionChart', 'division', 'jpg')">JPG</button>
        </div>
      </div>
    </div>

    <!-- Class Distribution -->
    <div class="col-md-6 col-xl-3">
      <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="chart-title mb-0">Class Distribution</h6>
          <span class="badge bg-primary" id="classTotal">0</span>
        </div>
        <canvas id="classChart"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('classChart', 'class', 'png')">PNG</button>
          <button class="btn btn-sm btn-outline-light flex-grow-1" onclick="downloadChart('classChart', 'class', 'jpg')">JPG</button>
        </div>
      </div>
    </div>
    <!-- Registration Status -->
    {% comment %} <div class="col-md-6 col-xl-4">
      <div class="chart-card">
        <h6 class="chart-title">Registration Status</h6>
        <canvas id="statusChart"></canvas>
      </div>
    </div> {% endcomment %}
  </div>

  <!-- Export Section -->
  <hr class="my-4">
  <div class="card p-4 mt-4">
    <h5 class="mb-3">Export Data</h5>
    <form method="get" action="{% url 'app:admin_export' %}" class="row g-3 align-items-end">
      <div class="col-md-2">
        <label class="form-label small fw-bold">Year</label>
        <input name="year" class="form-control" placeholder="2025">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold">Division</label>
        <input name="division" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold">District</label>
        <input name="district" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold">Upazila</label>
        <input name="upazila" class="form-control">
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-primary w-100">Download CSV</button>
      </div>
    </form>
  </div>
</div>

<style>
  .kpi-card {
    padding: 1.5rem;
    border-radius: 12px;
    color: white;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    backdrop-filter: blur(10px);
    transition: transform 200ms, box-shadow 200ms;
  }
  
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
  }
  
  .kpi-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.9;
    margin-bottom: 0.5rem;
  }
  
  .kpi-value {
    font-size: 2rem;
    font-weight: 700;
  }
  
  .chart-card {
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 1.5rem;
    height: 100%;
  }
  
  .chart-title {
    font-weight: 600;
    margin-bottom: 1rem;
    color: #fff;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  const chartConfig = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: { labels: { color: '#aaa', font: { size: 11 } } },
      datalabels: {
        color: '#fff',
        font: { weight: 'bold', size: 12 },
        formatter: (value, context) => {
          const sum = context.dataset.data.reduce((a, b) => a + b, 0);
          const percentage = ((value * 100) / sum).toFixed(1);
          return percentage + '%';
        }
      }
    }
  };

  const colorPalettes = {
    gender: ['#667eea', '#764ba2', '#f093fb'],
    category: ['#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a'],
    division: ['#fee140', '#30cfd0', '#330867', '#ff6b6b', '#4ecdc4'],
    class: ['#ffd700', '#ff8c00', '#ff6347', '#00ced1', '#32cd32'],
    status: ['#667eea', '#f5576c']
  };

  function makeGradientColors(count, baseColors) {
    if (count <= baseColors.length) return baseColors.slice(0, count);
    const result = [];
    for (let i = 0; i < count; i++) {
      result.push(baseColors[i % baseColors.length]);
    }
    return result;
  }

  function createChart(ctxId, dataObj, paletteKey) {
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    
    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const colors = makeGradientColors(labels.length, colorPalettes[paletteKey] || colorPalettes.gender);
    
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: colors,
          borderColor: 'rgba(0,0,0,0.1)',
          borderWidth: 2
        }]
      },
      options: chartConfig,
      plugins: [ChartDataLabels]
    });
  }

  const genderData = {{ gender_counts|default:'{}'|safe }};
  const categoryData = {{ category_counts|default:'{}'|safe }};
  const divisionData = {{ division_counts|default:'{}'|safe }};
  const classData = {{ class_counts|default:'{}'|safe }};
  const statusData = {{ registration_status|default:'{}'|safe }};

  createChart('genderChart', genderData, 'gender');
  createChart('categoryChart', categoryData, 'category');
  createChart('divisionChart', divisionData, 'division');
  createChart('classChart', classData, 'class');
  createChart('statusChart', statusData, 'status');
</script>

<script>
  function downloadChart(canvasId, chartName, type) {
    const canvas = document.getElementById(canvasId);
    const mime = type === 'png' ? 'image/png' : 'image/jpeg';
    const url = canvas.toDataURL(mime, 1.0);
    const a = document.createElement('a');
    a.href = url;
    a.download = chartName + '_distribution.' + type;
    a.click();
  }

  // Update totals after chart creation
  setTimeout(() => {
    document.getElementById('genderTotal').textContent = Object.values({{ gender_counts|default:'{}'|safe }}).reduce((a,b)=>a+b, 0);
    document.getElementById('categoryTotal').textContent = Object.values({{ category_counts|default:'{}'|safe }}).reduce((a,b)=>a+b, 0);
    document.getElementById('divisionTotal').textContent = Object.values({{ division_counts|default:'{}'|safe }}).reduce((a,b)=>a+b, 0);
    document.getElementById('classTotal').textContent = Object.values({{ class_counts|default:'{}'|safe }}).reduce((a,b)=>a+b, 0);
  }, 100);
</script>
{% endblock %}
